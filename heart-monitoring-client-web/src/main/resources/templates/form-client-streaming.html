<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Heartbeat Client Streaming</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f7f7f7;
            font-family: Arial, sans-serif;
        }
        #streamedDataList {
            max-height: 200px;
            overflow-y: auto;
        }
        #summaryCard {
            display: none;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h2 class="mb-4 text-center">Patient Heartbeat Client Streaming</h2>

    <div class="mb-3">
        <label for="jsonInput" class="form-label">Paste JSON (PatientClientStreamingDTO)</label>
        <textarea id="jsonInput" class="form-control" rows="5">
{"name": "Schopenhauer", "heartbeat": 72, "timestamp": "2025-06-21T15:00:00"}
    </textarea>
    </div>

    <div class="d-flex gap-2 mb-4">
        <button id="sendBtn" class="btn btn-primary">Send</button>
        <button id="stopBtn" class="btn btn-danger">Stop & Get Summary</button>
    </div>

    <h5>Sent Heartbeats:</h5>
    <ul id="streamedDataList" class="list-group mb-4"></ul>

    <div id="summaryCard" class="card shadow p-3">
        <h5 class="card-title">Patient Summary</h5>
        <div class="card-body">
            <p><strong>Name:</strong> <span id="summaryName"></span></p>
            <p><strong>Average BPM:</strong> <span id="summaryAvg"></span></p>
            <p><strong>Min BPM:</strong> <span id="summaryMin"></span></p>
            <p><strong>Max BPM:</strong> <span id="summaryMax"></span></p>
            <p><strong>Timestamp:</strong> <span id="summaryTime"></span></p>
        </div>
    </div>
</div>

<script>
    let writer = null;
    let sentData = [];

    async function setupStreamingConnection() {
        const { readable, writable } = new TransformStream();
        writer = writable.getWriter();

        fetch('/heartbeat-client-stream', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-ndjson' },
            body: readable,
            duplex: 'half'
        }).then(async response => {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let result = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                result += decoder.decode(value, { stream: true });
                try {
                    const json = JSON.parse(result);
                    showSummary(json);
                    break;
                } catch (err) {
                    // Wait for more chunks
                }
            }
        }).catch(err => {
            console.error('Stream error:', err);
        });
    }

    document.getElementById('sendBtn').addEventListener('click', async () => {
        const input = document.getElementById('jsonInput').value.trim();
        if (!input) return;

        try {
            const json = JSON.parse(input);
            sentData.push(json);
            addSentToList(json);

            if (!writer) await setupStreamingConnection();

            const payload = JSON.stringify(json) + '\n';
            await writer.write(new TextEncoder().encode(payload));

            document.getElementById('jsonInput').value = '';
        } catch (err) {
            alert('Invalid JSON');
        }
    });

    document.getElementById('stopBtn').addEventListener('click', async () => {
        if (writer) {
            await writer.close(); // completes the stream
            writer = null;
        }
    });

    function addSentToList(data) {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.textContent = `Name: ${data.name}, BPM: ${data.heartbeat}, Time: ${data.timestamp}`;
        document.getElementById('streamedDataList').appendChild(li);
    }

    function showSummary(summary) {
        document.getElementById('summaryName').textContent = summary.name;
        document.getElementById('summaryAvg').textContent = summary.averageBpm;
        document.getElementById('summaryMin').textContent = summary.minBpm;
        document.getElementById('summaryMax').textContent = summary.maxBpm;
        document.getElementById('summaryTime').textContent = summary.timestamp;
        document.getElementById('summaryCard').style.display = 'block';
    }
</script>
</body>
</html>